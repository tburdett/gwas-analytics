# Database Queries for GWAS Analysis

## Get all Studies

SELECT DISTINCT(PUBMED_ID) FROM STUDY ORDER BY PUBMED_ID

## Get all Studies and their traits

SELECT s.PUBMED_ID, e.URI, e.TRAIT
FROM STUDY s
JOIN STUDY_EFO_TRAIT se ON s.id = se.STUDY_ID
JOIN EFO_TRAIT e ON se.EFO_TRAIT_ID = e.ID
ORDER BY pubmed_id

## Get all Studies and the SNPs they have identified

SELECT DISTINCT s.PUBMED_ID, snp.RS_ID
FROM STUDY s
JOIN ASSOCIATION a on s.ID = a.STUDY_ID
JOIN ASSOCIATION_LOCUS al ON a.ID = al.ASSOCIATION_ID
JOIN LOCUS_RISK_ALLELE lra ON al.LOCUS_ID = lra.LOCUS_ID
JOIN RISK_ALLELE_SNP ras ON lra.RISK_ALLELE_ID = ras.RISK_ALLELE_ID
JOIN SINGLE_NUCLEOTIDE_POLYMORPHISM snp ON ras.SNP_ID = snp.ID
ORDER BY pubmed_id

## Get all EFO traits, grouped by date range for the first study that used this trait
SELECT BUCKET, TO_CHAR(MIN(FIRST_ADDED), 'YYYY-MM') AS DATE_FROM, COUNT(*) AS NUMBER_OF_TRAITS FROM (
  SELECT URI, TRAIT, FIRST_ADDED, WIDTH_BUCKET(FIRST_ADDED, TO_DATE('2008-11-01', 'YYYY-MM-DD'), TO_DATE('2017-02-01', 'YYYY-MM-DD'), 99) AS BUCKET FROM (
    SELECT DISTINCT URI, TRAIT, MIN(STUDY_ADDED_DATE) AS FIRST_ADDED FROM (
      SELECT s.PUBMED_ID, e.URI, e.TRAIT, h.STUDY_ADDED_DATE FROM STUDY s
      JOIN STUDY_EFO_TRAIT se ON s.ID = se.STUDY_ID
      JOIN EFO_TRAIT e ON se.EFO_TRAIT_ID = e.ID
      JOIN HOUSEKEEPING h ON s.HOUSEKEEPING_ID = h.ID
      WHERE h.STUDY_ADDED_DATE IS NOT NULL
    ) GROUP BY URI, TRAIT
  ) ORDER BY FIRST_ADDED
) GROUP BY BUCKET ORDER BY BUCKET

## Get how often traits are used
SELECT USES, COUNT(\*) AS FREQ FROM (
  SELECT URI, COUNT(\*) AS USES FROM (
    SELECT s.PUBMED_ID, e.URI, e.TRAIT, h.STUDY_ADDED_DATE FROM STUDY s
    JOIN STUDY_EFO_TRAIT se ON s.ID = se.STUDY_ID
    JOIN EFO_TRAIT e ON se.EFO_TRAIT_ID = e.ID
    JOIN HOUSEKEEPING h ON s.HOUSEKEEPING_ID = h.ID
    WHERE h.STUDY_ADDED_DATE IS NOT NULL
  ) GROUP BY URI, TRAIT
) GROUP BY USES
ORDER BY USES